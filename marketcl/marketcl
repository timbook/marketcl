#!/usr/bin/env python3

import os
import sys
import json

import click

from marketcl.dialogues import startup_check, make_game, parse_game_arg
from marketcl.items import Game
from marketcl.plots import Plotter, plot_desc

MARKETCL_PATH = os.path.expandvars("$HOME/.marketcl")

game_opts = click.Choice(["new", "ls", "switch", "rm"])
plot_opts = click.Choice(["macd", "sroc", "wr"])

@click.command()
@click.option("--ls", "-l", is_flag=True, help="List holdings")
@click.option("--buy", "-b", is_flag=True, help="Buy a new stock")
@click.option("--sell", "-s", is_flag=True, help="Sell stock from your current portfolio")
@click.option("--game", "-g", "game_choice", type=game_opts,
              help="Start a new game, list ongoing games, switch games, or delete an existing game")
@click.option("--plot", "-p", "plot_choice", type=plot_opts,
              help="Plot your choice of market indicators for a given symbol")
@click.option("--plot-help", "phelp", type=plot_opts,
              help="Description and advice for plotting the given plot type")
@click.option("--sym", "-m")
def main(ls, buy, sell, game_choice, plot_choice, phelp, sym):
    if game_choice:
        parse_game_arg(game_choice, MARKETCL_PATH)
        sys.exit(0)

    game = Game(MARKETCL_PATH)

    if ls:
        game.print()
        sys.exit(0)

    if buy:
        game.buy()
        sys.exit(0)

    if sell:
        game.sell()
        sys.exit(0)

    if phelp:
        plot_desc(phelp)

    if plot_choice:
        if not sym:
            sym = input("What symbol would you like to plot? ")
        plotter = Plotter(sym)
        plotter.plot(plot_choice)
        sys.exit(0)

if __name__ == "__main__":
    startup_check(MARKETCL_PATH)
    main()
